<html>
    <head>
        <meta charset="UTF-8">
        <title>Main</title>
        <link rel="stylesheet" href="/src/css/main.css">
        <!-- <script src="/main.js"></script> -->
        <script>
			let tries = 0;
			const mainName = "/main.js";
			function loadScript(url, callback)
			{
				// Adding the script tag to the head as suggested before
				var head = document.head;
				var script = document.createElement('script');
				script.type = 'text/javascript';
				script.src = url;

				const try_again = () => {
					script.remove();
					let new_url = mainName + "?____tries___="+tries;
					console.log("trying again for", new_url)
					loadScript(new_url, callback);
					tries += 1;
				}

				// Then bind the event to the callback function.
				// There are several events for cross browser compatibility.
				script.onreadystatechange = () => {
					console.log("state change", script.readyState);
					return callback()
				};
				script.onload = (args, second_args) => {
					console.log("onload", args, second_args, script.readyState);
					console.log("Elm?", typeof Elm);
					if (typeof Elm === "undefined") { 
						try_again();
					} else {
						return callback()
					}
				};
				script.onerror = (err) => {
					console.log("ON ERROR", err, script.readyState);
					// return callback()
				};

				// Fire the loading
				head.appendChild(script);
			}

            function init_elm() {
                window.app = Elm.Main.init({
                    node: document.getElementById('myapp')
                });


                app.ports && app.ports.test_port_sending && app.ports.test_port_sending.subscribe(function(message) {
                    console.log("received message: "+message);
                    send_to_elm()
                });

                function send_to_elm() {
                    app.ports && app.ports.test_port_receiving && app.ports.test_port_receiving.send("sent from js");
                };
                // console.log("ports exist? "+(app.ports && app.ports.test_port_receiving));

                app.ports.exec_jsonp.subscribe(function(url) {
                    console.log("subbing to exec_jsonp port");
                    execJsonp(url);
                });
            }

            var execJsonp = function(url) {
                console.log("executing jsonp");

                // Execute the URL by creating the script DOM element
                var script = document.createElement('script');
                script.type = 'text/javascript';
                script.async = true;
                script.src = url;

                // Insert the element, which executes the script
                var tag = document.getElementsByTagName('div')[0];
                tag.parentNode.insertBefore(script, tag);
                // Remove the temp element from the DOM, to avoid DOM bloat
                // You should be able to do this right away, without affecting JSONP execution
                script.parentNode.removeChild(script);
            };

            // JSONP callback; name must match what is defined in the execJsonp URL
            function jsonpCallback(data) {
                console.log("in jsonpCallback: ",{...data});
                window.app.ports.recv_reddit_listing.send(data);
            };

			loadScript(mainName, init_elm);

        </script>
    </head>

    <body>
        <h1>Error in elm initialization </h1>
        <h3>see console</h3>
        <div id="myapp"></div>
        <!-- <script> -->
        <!--     init_elm(); -->
        <!-- </script> -->
    </body>
</html>