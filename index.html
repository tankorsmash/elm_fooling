<html>
    <head>
        <meta charset="UTF-8">
        <title>Main</title>
        <link rel="stylesheet" href="/src/css/main.css">

		<script src="https://sfxr.me/riffwave.js"></script>
		<script src="https://sfxr.me/sfxr.js"></script>

        <script src="/main.js"></script>
        <script>
            function init_elm() {
                window.app = Elm.Main.init({
                    node: document.getElementById('myapp')
                });


                app.ports && app.ports.test_port_sending && app.ports.test_port_sending.subscribe(function(message) {
                    console.log("received message: "+message);
                    send_to_elm()
                });

                function send_to_elm() {
                    app.ports && app.ports.test_port_receiving && app.ports.test_port_receiving.send("sent from js");
                };
			// console.log("ports exist? "+(app.ports && app.ports.test_port_receiving));

			app.ports.exec_jsonp.subscribe(function(url) {
				console.log("subbing to exec_jsonp port");
				execJsonp(url);
			});

			app.ports.sfxrOut.subscribe(function(outMsg) {
				console.log("outMsg:", outMsg);
				var sound = {
				  "oldParams": true,
				//shape
				/* var SQUARE = 0;
					   var SAWTOOTH = 1;
					   var SINE = 2;
					   var NOISE = 3;
					*/
					  "wave_type": 1,

					//envelope
					  "p_env_attack": 0,
					  "p_env_sustain": 0.31718502829007483,
					  "p_env_punch": 0,
					  "p_env_decay": 0.2718540993592685,

					//frequency
					  "p_base_freq": 0.26126191208337196,
					  "p_freq_limit": 0,
					  "p_freq_ramp": 0.43787689856926615,
					  "p_freq_dramp": 0,

					//vibrato
					  "p_vib_strength": 0,
					  "p_vib_speed": 0,

					//arpeggiation
					  "p_arp_mod": 0,
					  "p_arp_speed": 0,

					//duty cycle (only SQUARE and SAWTOOTH can use duty)
					  "p_duty": 1,
					  "p_duty_ramp": 0,

					//retrigger
					  "p_repeat_speed": 0.7558565452384385,

					//flanger
					  "p_pha_offset": 0,
					  "p_pha_ramp": 0,

					//lowpass filter
					  "p_lpf_freq": 1,
					  "p_lpf_ramp": 0,
					  "p_lpf_resonance": 0,

					//highpass filter
					  "p_hpf_freq": 0,
					  "p_hpf_ramp": 0,

					  "sound_vol": 0.05,
					  "sample_rate": 44100,
					  "sample_size": 8
					};

					playSound();
				});
            }

            var execJsonp = function(url) {
                console.log("executing jsonp");

                // Execute the URL by creating the script DOM element
                var script = document.createElement('script');
                script.type = 'text/javascript';
                script.async = true;
                script.src = url;

                // Insert the element, which executes the script
                var tag = document.getElementsByTagName('div')[0];
                tag.parentNode.insertBefore(script, tag);
                // Remove the temp element from the DOM, to avoid DOM bloat
                // You should be able to do this right away, without affecting JSONP execution
                script.parentNode.removeChild(script);
            };

            // JSONP callback; name must match what is defined in the execJsonp URL
            function jsonpCallback(data) {
                console.log("in jsonpCallback: ",{...data});
                window.app.ports.recv_reddit_listing.send(data);
            };

			function playSound(sound) {
				var s = new SoundEffect(sound).generate();
				// returns a webaudio object if supported, or an Audio object
				s.getAudio().play();
			};

        </script>
    </head>

    <body>
        <h1>Error in elm initialization </h1>
        <h3>see console</h3>
        <div id="myapp"></div>
        <script>
            init_elm();
        </script>
    </body>
</html>